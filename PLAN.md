# PLAN：Android 12–16 存储访问监控 + 重定向 + 只读（按应用规则）模块

## 0. 目标与非目标

### 目标

- 支持 Android 12–16（含主流 AOSP/常见厂商差异适配策略）。
- 以“应用”为单位配置并动态生效（无需重启系统/应用）。
- 功能：
  1. **监控**：对配置的多个路径，记录“哪个应用/进程在什么时间执行了什么操作（读/写/创建/删除/重命名等）”，输出可查询日志。
  2. **重定向**：对某应用将源路径视为目标路径（规则有优先级、可多条、支持 src==dst 代表允许直通）。
  3. **只读**：对某应用指定路径只读，禁止写入/创建/删除/重命名等。
  4. **覆盖面**：同时覆盖 native 与 framework/Java 层常见文件访问路径（以最大化兼容“系统文件 API 保存”场景）。
  5. **子进程/isolated/插件进程**：同一“应用规则”需覆盖到其相关派生进程，尽量避免侧漏。
- WebUI：KernelSU WebUI，精美卡片化+毛玻璃；应用列表、规则配置、监控配置、关于页；显示规则数量、已生效标识；支持搜索与筛选系统/用户应用。
- GitHub Actions 自动构建并产出**可直接刷入的模块 zip**（不嵌套压缩包）。

### 非目标（明确边界，减少不可控复杂度）

- 不保证 100% 覆盖所有厂商 ROM 私有文件框架实现（以“可配置、可回退”为策略）。
- 不承诺对所有应用的“检测对抗”做到绝对不可见（但尽量设计为低侵入、稳定优先）。
- 不试图改变 Android 权限模型本身（仍依赖 root 能力与进程内拦截/代理链路）。

------

## 1. 总体架构

### 1.1 组件划分

1. **Zygisk 注入层（Native）**

- 在 zygote 派生阶段进入 app 进程，初始化规则系统与拦截/记录管线。
- 负责：
  - 进程身份识别（uid、包名、进程名、isolated 标识等）
  - 规则拉取与热更新触发
  - 文件访问“路径标准化、规则匹配、执行策略（直通/重定向/只读拒绝/监控记录）”
  - 事件上报（低开销）

1. **Root 守护进程（daemon）**

- 常驻（由 KernelSU module service 启动），作为“配置中心 + 日志中心 + 规则分发中心”：
  - 配置文件读写与校验（按包名/规则类型存储）
  - 规则版本号管理（原子递增）
  - 提供 IPC：进程查询版本、拉取规则、上报日志、查询状态
  - 日志落盘与轮转、导出

1. **KernelSU WebUI（前端）**

- 通过 kernelsu API 获取应用列表/图标/uid 等信息。
- 通过 `exec/spawn` 调用 daemon CLI（或一个薄封装命令）完成：
  - 读取/保存规则
  - 切换开关
  - 拉取日志摘要
  - 查看“已生效/已挂载”状态

> 注：是否引入 FUSE 层作为“目录视图/代理文件系统”由阶段性决策决定（见第 4 部分“实现路线与分期”）。

------

## 2. 规则系统设计

### 2.1 配置存储

- 单一 JSON（或 JSON + 二进制缓存）：
  - 全局配置：监控总开关、日志级别、性能参数、黑白名单策略等
  - per-app 配置：
    - enabled
    - redirectRules（有序）
    - readOnlyRules
    - monitorPaths（每条可配置 ops/级别）
    - 状态字段（可选）：lastAppliedVersion、mounted 标记等

### 2.2 路径标准化与匹配原则

- 所有输入路径（规则与运行时路径）统一标准化：
  - 处理重复分隔符、`.`、`..`、尾部斜杠语义
  - 避免不必要的真实路径解析导致符号链接/挂载点差异引发安全绕过
- 匹配方式：
  - 以“前缀匹配 + 目录边界”判定是否命中
  - 重定向规则：按添加顺序优先（第一条命中即应用）
  - 只读规则：可按“更具体路径优先”或“按添加顺序优先”，需在 PRD 中固定

### 2.3 重定向组合规则（优先级示例要求）

- 规则集按顺序扫描：
  - 如果命中 `/storage/emulated/0/Download/`，则不再考虑更上层 `/storage/emulated/0/` 的规则
- 对子路径的处理：
  - 将相对部分拼接到 dst（确保 `/` 处理一致）
- 支持 src==dst：表示显式允许直通（同时可用于“覆盖更上层重定向”）。

------

## 3. 覆盖面：文件访问入口分类（方案层面）

为满足“系统文件 API 保存也纳入重定向/只读/监控”，按来源分三类路径入口：

### 3.1 Native/NDK/系统库路径

- 目标：覆盖绝大多数最终落到系统调用的路径型文件操作。
- 策略：在“路径进入内核/文件系统前”统一改写/拒绝/记录。

### 3.2 Java/Framework 层路径

- 目标：覆盖 Java 侧对 path/mode 的预处理，以及某些不经由常规路径的文件打开方式（例如通过框架间接创建 fd）。
- 策略：在 Java 层对“路径字符串 + mode/flags”进行同样的规则决策，并将决策传递到下游（必要时与 native 决策保持一致）。

### 3.3 Content/SAF/MediaStore 路径（URI 而非传统 path）

- 目标：当应用通过 `content://` URI 打开/保存时，重定向/只读需定义等价语义：
  - 监控：记录 URI、调用方、时间、mode
  - 只读：禁止写 mode
  - 重定向：如果可将 URI 映射到真实路径（或可控 provider），按策略处理；否则至少执行监控与只读（重定向可能受限）

> 关键决策：对于 URI 场景的“重定向”是否作为必选。若强制，复杂度与 ROM 差异显著上升；建议作为可选增强能力。

------

## 4. 实现路线与分期（推荐分阶段交付，降低风险）

### Phase 0：工程骨架与CI（1周）

- 建立模块目录结构、daemon 框架、WebUI 框架、CI 打包。
- 输出：能刷入、daemon 能启动、WebUI 能显示应用列表并读写配置（不启用拦截）。

### Phase 1：监控 MVP（1–2周）

- 在进程侧实现“事件采集管线”与 daemon 落盘：
  - 记录：包名/进程名/uid/tid、时间、操作类型、路径或 URI、结果码
  - 仅对配置 monitorPaths 命中的事件记录（默认关闭全量）
- 性能：批量上报、日志轮转策略。
- 输出：WebUI 可查看某 app 的监控摘要/导出日志。

### Phase 2：只读 MVP（1–2周）

- 对指定 path 实施写操作拒绝（覆盖 native + Java/URI mode）。
- 输出：只读规则可动态生效；WebUI 有规则计数与开关。

### Phase 3：重定向 MVP（2–4周）

- 先实现 path 型重定向闭环（按规则优先级、拼接子路径、src==dst 覆盖）。
- 对“目录遍历/列举”一致性做策略：确保应用看到的内容与实际 dst 一致（必要时引入目录视图层/代理层）。
- 输出：常见应用场景可用（下载目录、文档目录等）。

### Phase 4：深度覆盖与侧漏收敛（持续迭代）

- 扩展到更多 Java/Framework 入口与 URI 场景。
- 子进程/isolated/插件进程规则继承策略：
  - 定义“规则归属判定”与“继承边界”（按 uid、包名、进程名、签名/沙箱标识等组合）
  - 设计规则下发缓存与更新一致性（避免进程间版本不一致）
- 输出：兼容性矩阵扩大、侧漏场景减少。

### Phase 5：FUSE/代理文件系统（可选，2–6周）

- 当需要“目录视图伪装/更一致的文件系统语义”时引入：
  - 由 daemon 或独立进程提供 FUSE 挂载点（每 app 或按规则集共享）
  - 将 src 映射为 FUSE 虚拟目录，背后指向 dst
- 输出：更一致的“像真实目录一样”的体验；代价是功耗与复杂度上升。

------

## 5. 动态生效机制（无重启）

### 5.1 版本号与增量

- config 带 version，每次 WebUI 保存规则后 version++。
- 进程内缓存 rules + cachedVersion。
- 更新触发策略（低功耗）：
  - 时间阈值轮询版本号（如 2–5s，可配置）
  - 或操作计数阈值（如每 N 次文件操作检查一次）
  - daemon 主动推送（可选，取决于 IPC 设计）

### 5.2 一致性与回退

- 更新期间做到“旧规则继续可用，新规则原子替换”。
- 规则解析失败：
  - 进程侧继续使用上一次有效规则
  - daemon 记录错误并在 WebUI 提示

------

## 6. 日志与审计设计

### 6.1 日志格式

- JSONL 每行一条事件，字段固定，方便后处理：
  - ts、pkg、proc、uid、tid、op、path/uri、mappedPath、result、errno、ruleId（命中规则索引）、mode/flags（如有）

### 6.2 隐私与容量

- 默认不记录文件内容，只记录元数据。
- 日志按 app 分目录 + 日期轮转，限制最大占用（全局 MB 上限）。
- WebUI 支持：
  - 按 app / 时间范围 / op 类型过滤
  - 一键清空某 app 日志

------

## 7. WebUI 交互与页面规划

### Tab 1：应用列表

- 数据源：KernelSU `listPackages/getPackagesInfo`，图标 `ksu://icon/`
- 交互：
  - 搜索（label/package）
  - 筛选系统/用户
  - 排序：已配置规则置顶；显示 redirect 数 / readonly 数；显示“已生效”标识
- 点击进入 app 详情页

### App 详情页：规则配置

- 三块卡片：
  1. 重定向规则（可排序、启停、src/dst 输入、校验、提示优先级）
  2. 只读规则（路径列表）
  3. 监控路径与操作类型（可多选 ops）
- 保存即生效：调用 daemon 写 config + bump version

### Tab 2：监控配置

- 全局开关、日志级别、容量上限、刷新间隔等
- 导出/清理工具

### Tab 3：关于

- 介绍、注意事项、兼容性说明、问题反馈入口

UI 风格：卡片化、现代化、毛玻璃（backdrop-filter），统一间距与排版规范。

------

## 8. 性能与功耗策略

- **默认最小化拦截范围**：仅对配置过规则的 app 启用完整逻辑；其余进程仅轻量判定或完全跳过。
- **规则匹配优化**：
  - 预编译规则（前缀表/树）
  - 路径标准化避免频繁分配（复用缓冲、线程局部存储）
- **日志批处理**：
  - ring buffer + 定时 flush
  - 严格限制高频路径的记录（采样/节流可选）
- **热更新低频轮询**：避免每次文件操作都 IPC。

------

## 9. 兼容性与测试计划

### 9.1 测试矩阵

- Android 12/13/14/15/16（至少各 1 台或 1 个 GSI/模拟器 + 真实机）
- 文件访问类型：
  - Java File、NDK、Kotlin IO、MediaStore/SAF
- 进程类型：
  - 主进程、:remote、多进程服务、isolated、WebView/插件（按常见框架样例）
- 存储路径：
  - `/storage/emulated/0/`
  - app-specific external（`Android/data/.../files`）
  - Download/DCIM/Documents
- 操作类型：
  - open/read/write/create/delete/rename/mkdir/truncate

### 9.2 回归策略

- 每次新增覆盖面都跑固定用例集（脚本化）：
  - 规则优先级用例（你描述的 Download 覆盖上层规则）
  - src==dst 直通覆盖用例
  - 只读拒绝写用例
  - 动态修改规则即时生效用例

------

## 10. 发布与CI/CD

### GitHub Actions

- 构建：
  - NDK 编译 native 部分（按 ABI）
  - 编译 daemon（静态/动态按策略）
  - WebUI 构建（vite/webpack）输出到 module/webroot
- 打包：
  - 直接对 module 根目录 zip 成可刷包（不嵌套）
- 产物命名：
  - `ModuleName-<version>-<commit>.zip`

------

## 11. 风险清单与缓解

1. **Android 版本碎片化导致 Java/Framework 行为差异**

- 缓解：分阶段覆盖、开关控制、兼容性矩阵、逐步扩展。

1. **URI/SAF 场景难以完整重定向**

- 缓解：至少保证监控与只读；重定向作为可选增强。

1. **性能与功耗**

- 缓解：只对命中 app 启用；规则预编译；日志批量；低频热更新。

1. **侧漏（子进程/isolated/插件）归属判定复杂**

- 缓解：先定义清晰的“规则继承模型”，通过可观测日志不断发现漏点并迭代修正。

------

## 12. 里程碑与交付物

- M0（第1周）：可刷模块 + daemon + WebUI 应用列表/配置读写
- M1（第2–3周）：监控闭环（按路径过滤 + 日志查看/导出）
- M2（第4–5周）：只读闭环（动态生效 + 监控记录拒绝原因）
- M3（第6–9周）：重定向 MVP（路径重定向 + 规则优先级 + 基础一致性）
- M4（持续）：深度覆盖增强 + 侧漏收敛 + 可选 FUSE