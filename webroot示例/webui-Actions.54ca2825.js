let e=0;function t(t,n){return void 0===n&&(n={}),new Promise((o,a)=>{let l=`exec_callback_${Date.now()}_${e++}`;function s(e){delete window[e]}window[l]=(e,t,n)=>{o({errno:e,stdout:t,stderr:n}),s(l)};try{ksu.exec(t,JSON.stringify(n),l)}catch(e){a(e),s(l)}})}function n(){this.listeners={}}function o(){this.listeners={},this.stdin=new n,this.stdout=new n,this.stderr=new n}function a(e){ksu.toast(e)}function l(e){try{return JSON.parse(ksu.listPackages(e))}catch(e){return[]}}n.prototype.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},n.prototype.emit=function(e,...t){this.listeners[e]&&this.listeners[e].forEach(e=>e(...t))},o.prototype.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},o.prototype.emit=function(e,...t){this.listeners[e]&&this.listeners[e].forEach(e=>e(...t))};var s="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z";const r="/data/Namespace-Proxy",i=`${r}/injector.conf`,c=`${r}/monitor_ignore.conf`,d="/data/adb/modules/Namespace-Proxy/bin/log_ctl",u="/storage/emulated/0",m="/data/media/0";let g=new Map,p=[],y=new Map,h="grid",E=new Map,v=null,f=null,L=new Set,I=null,M="filterUser",b=null,H={offset:0,loading:!1,hasMore:!0,term:""},w={offset:0,loading:!1,hasMore:!0,term:""};const C=(e,t=24,n="currentColor")=>`<svg viewBox="0 0 24 24" fill="${n}" width="${t}" height="${t}"><path d="${e}"/></svg>`,B={ANDROID:C("M16.61 15.15C16.15 15.15 15.77 14.78 15.77 14.32S16.15 13.5 16.61 13.5H16.61C17.07 13.5 17.45 13.86 17.45 14.32C17.45 14.78 17.07 15.15 16.61 15.15M7.41 15.15C6.95 15.15 6.57 14.78 6.57 14.32C6.57 13.86 6.95 13.5 7.41 13.5H7.41C7.87 13.5 8.24 13.86 8.24 14.32C8.24 14.78 7.87 15.15 7.41 15.15M16.91 10.14L18.58 7.26C18.67 7.09 18.61 6.88 18.45 6.79C18.28 6.69 18.07 6.75 18 6.92L16.29 9.83C14.95 9.22 13.5 8.9 12 8.91C10.47 8.91 9 9.24 7.73 9.82L6.04 6.91C5.95 6.74 5.74 6.68 5.57 6.78C5.4 6.87 5.35 7.08 5.44 7.25L7.1 10.13C4.25 11.69 2.29 14.58 2 18H22C21.72 14.59 19.77 11.7 16.91 10.14H16.91Z",32,"#757575"),ENV:C("M12,16L19.36,10.27L21,9L12,2L3,9L4.63,10.27M12,18.54L4.62,12.81L3,14.07L12,21.07L21,14.07L19.37,12.8L12,18.54Z",24,"#1266f1"),DELETE:C("M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z",18,"currentColor"),FOLDER:C("M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z",16,"#ffca28"),FILE:C("M13,9V3.5L18.5,9M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z",16,"#9e9e9e"),REFRESH:C("M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z",20,"#000"),SEARCH:C("M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z",18,"#868e96"),PLUS:C(s,16,"#fff"),CLOSE:C("M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z",28,"#5f6368"),CHEVRON:C("M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z",20,"#adb5bd"),FILTER:C("M6,13H18V11H6M3,6V8H21V6M10,18H14V16H10V18Z",24,"#fff"),GRID:C("M3,11H11V3H3M3,21H11V13H3M13,21H21V13H13M13,3V11H21V3",24,"#fff"),LIST:C("M9,5V9H21V5M9,19H21V15H9M9,14H21V10H9M4,9H8V5H4M4,19H8V15H4M4,14H8V10H4V14Z",24,"#fff"),STOP:C("M18,18H6V6H18V18Z",20,"#dc3545"),PLAY:C("M8,5.14V19.14L19,12.14L8,5.14Z",20,"#36a420"),EYE_OFF:C("M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.74,7.13 11.35,7 12,7Z",20,"currentColor"),CLEAR:C("M15,16H19V18H15V16M15,8H22V10H15V8M15,12H21V14H15V12M3,18A2,2 0 0,0 5,20H11A2,2 0 0,0 13,18V8H3V18M14,5H11L10,4H6L5,5H2V7H14V5Z",20,"#fff")},$=async e=>{try{let n=await t(e);if(n.errno&&0!==n.errno)return console.warn(`Cmd failed: ${e}`,n.stderr),"";return n.stdout?n.stdout.trim():""}catch(e){return console.error("Exec exception:",e),a(`\u{6267}\u{884C}\u{9519}\u{8BEF}: ${e.message||e}`),""}},S=async()=>{try{let e=await $("ps -A -o args | grep fuse_daemon | grep -v grep"),t=new Set;return e&&e.split("\n").forEach(e=>{let n=e.match(/--pkg=([a-zA-Z0-9._]+)/);n&&t.add(n[1])}),t}catch(e){return console.error("Fetch mounts error",e),new Set}},T=async()=>{try{L=await S(),document.querySelectorAll("#appList .list-item").forEach(e=>{let t=e.dataset.pkg;if(!t)return;let n=e.querySelector(".app-header");if(!n)return;let o=n.querySelector(".badge-success"),a=L.has(t);a&&!o?n.insertAdjacentHTML("beforeend",'<span class="badge badge-success">MOUNTED</span>'):!a&&o&&"MOUNTED"===o.textContent&&o.remove()})}catch(e){console.error("Update mount status error",e)}},A=async()=>{try{let e=document.getElementById("statusBadge"),t=document.getElementById("statusInfo"),n=document.getElementById("btnToggleStatus"),o=await $("pidof injector");o||(o=await $("pgrep -x injector")),(b=o?o.split(" ")[0]:null)?(e.className="badge badge-success",e.textContent="RUNNING",t.textContent=`PID: ${b}`,"running"!==n.getAttribute("data-status")&&(n.innerHTML=B.STOP,n.style.background="rgba(220, 53, 69, 0.1)",n.setAttribute("data-status","running"))):(e.className="badge badge-gray",e.textContent="STOPPED",t.textContent="OFFLINE","stopped"!==n.getAttribute("data-status")&&(n.innerHTML=B.PLAY,n.style.background="rgba(54, 164, 32, 0.1)",n.setAttribute("data-status","stopped"))),await T()}catch(e){console.error("Check status error",e)}};document.addEventListener("DOMContentLoaded",()=>{let e=(e,t)=>{let n=document.getElementById(e);n&&(n.innerHTML=t)};e("iconSearch",B.SEARCH),e("iconIoSearch",B.SEARCH),e("iconFilter",B.FILTER),e("iconEnvView",B.LIST),e("btnMonitorIgnore",B.EYE_OFF),e("iconClearIo",B.CLEAR),e("iconClearLog",B.CLEAR),document.querySelectorAll(".btn-close").forEach(e=>e.innerHTML=B.CLOSE);let t=(e,t)=>{let n=document.getElementById(e);n&&(n.innerHTML=t)};t("btnNewEnv",`<span style="display:flex;align-items:center;gap:4px">${C(s,14,"#fff")} \u{65B0}\u{5EFA}</span>`),t("btnAddRuleRow",`<span style="display:flex;align-items:center;justify-content:center;gap:6px">${C(s,16,"#fff")} \u{6DFB}\u{52A0}\u{89C4}\u{5219}</span>`),t("btnAddIgnoreRow",`<span style="display:flex;align-items:center;justify-content:center;gap:6px">${C(s,16,"#fff")} \u{6DFB}\u{52A0}\u{8DEF}\u{5F84}</span>`),N(),A(),I&&clearInterval(I),I=setInterval(A,2e3),document.getElementById("appSearch").oninput=D,document.getElementById("btnEnvViewToggle").onclick=()=>{h="grid"===h?"list":"grid",document.getElementById("iconEnvView").innerHTML="grid"===h?B.LIST:B.GRID,O()};let n=document.getElementById("btnFilterFab"),o=document.getElementById("filterOptions");n&&(n.onclick=e=>{e.stopPropagation(),o.classList.toggle("show")},document.addEventListener("click",e=>{o.contains(e.target)||n.contains(e.target)||o.classList.remove("show")})),document.querySelectorAll(".filter-opt").forEach(e=>{e.onclick=()=>{M=e.dataset.filter,document.querySelectorAll(".filter-opt").forEach(e=>e.classList.remove("active")),e.classList.add("active"),o.classList.remove("show"),D()}});let l=document.getElementById("ioTableContainer"),r=k(()=>{H.offset=0,H.hasMore=!0,H.term=document.getElementById("ioSearch").value.trim(),document.getElementById("ioTableBody").innerHTML="",x()},500);document.getElementById("ioSearch").addEventListener("input",r),l&&l.addEventListener("scroll",()=>{l.scrollTop+l.clientHeight>=l.scrollHeight-50&&x()});let i=document.getElementById("btnClearIo");i&&(i.onclick=async()=>{await $(`${d} clear-io`),a("IO 日志已清理"),H.offset=0,H.hasMore=!0,document.getElementById("ioTableBody").innerHTML="",x()});let c=document.getElementById("logSourceSelect"),u=document.getElementById("logViewer");c&&c.addEventListener("change",()=>{w.offset=0,w.hasMore=!0,u.innerHTML="",V()}),u&&u.addEventListener("scroll",()=>{"internal"===c.value&&u.scrollTop+u.clientHeight>=u.scrollHeight-50&&V()});let m=document.getElementById("btnClearLog");m&&(m.onclick=async()=>{let e=c.value;"zygisk"===e?await $("logcat -c"):await $(`${d} clear-sys`),a("日志已清空"),"internal"===e&&(w.offset=0,w.hasMore=!0,u.innerHTML=""),V()}),document.getElementById("btnMonitorIgnore").onclick=G});const k=(e,t)=>{let n;return function(...o){clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}},x=async()=>{if(H.loading||!H.hasMore)return;H.loading=!0;let e=document.getElementById("ioLoadingIndicator");e&&e.classList.remove("hidden");try{let e=await $(`${d} search-io "${H.term}" 50 ${H.offset} api`);if(e){let t=e.split("\n"),n=t,o=t[t.length-1];if(o.startsWith("DONE|")){let e=o.split("|");if(e.length>=3){let t=parseInt(e[2]);H.hasMore=!isNaN(t)&&t>0}else H.hasMore=!1;n=t.slice(0,-1)}else"OK"===o&&(H.hasMore=!1,n=t.slice(0,-1));n.length>0?(H.offset+=n.length,R(n)):H.hasMore||0!==H.offset||(document.getElementById("ioTableBody").innerHTML='<tr><td colspan="4" class="text-center text-muted">暂无数据</td></tr>')}else H.hasMore=!1}catch(e){console.error("Fetch IO logs error",e),a("获取 IO 日志失败"),H.hasMore=!1}finally{H.loading=!1,e&&e.classList.add("hidden")}},R=e=>{let t=document.getElementById("ioTableBody");t.innerHTML.includes("暂无数据")&&(t.innerHTML="");let n=e.map(e=>{if(!e.trim())return"";let t=e.split("|");if(t.length<2)return"";let n=parseInt(t[0]),o=t.slice(1).join("|"),a="未知",l="INFO",s=o,r=o.match(/^\[(.*?)\] \[(.*?)\] (.*)$/);r&&(a=r[1],l=r[2],s=r[3]);let i=new Date(1e3*n),c=isNaN(i.getTime())?"无效时间":i.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),d=g.get(a),u=d?d.appLabel:a;return`
            <tr>
                <td class="text-muted small font-monospace">${c}</td>
                <td><div class="text-truncate" style="max-width:100px" title="${a}">${u}</div></td>
                <td><span class="op-tag op-${l}">${l}</span></td>
                <td class="break-all font-monospace small">${s}</td>
            </tr>
        `}).join("");t.insertAdjacentHTML("beforeend",n)},V=async()=>{let e=document.getElementById("logSourceSelect").value,t=document.getElementById("logViewer"),n=document.getElementById("sysLoadingIndicator");if("zygisk"===e){try{t.textContent=await $("logcat -d -s Zygisk_NSProxy NamespaceProxy_Injector")||"无 Zygisk 日志",t.scrollTop=t.scrollHeight}catch(e){a("获取 Logcat 失败")}return}if(!w.loading&&w.hasMore){w.loading=!0,n&&n.classList.remove("hidden");try{let e=await $(`${d} search-sys "" 50 ${w.offset} api`);if(e){let n=e.split("\n"),o=n,a=n[n.length-1];if(a.startsWith("DONE|")){let e=a.split("|");if(e.length>=3){let t=parseInt(e[2]);w.hasMore=!isNaN(t)&&t>0}o=n.slice(0,-1)}else"OK"===a&&(w.hasMore=!1,o=n.slice(0,-1));if(o.length>0){w.offset+=o.length;let e=o.join("\n")+"\n";t.insertAdjacentText("beforeend",e)}else 0===w.offset&&(t.textContent="无内部日志")}else w.hasMore=!1}catch(e){console.error("Fetch Sys logs error",e),w.hasMore=!1}finally{w.loading=!1,n&&n.classList.add("hidden")}}};document.querySelectorAll(".nav-item").forEach(e=>{e.onclick=()=>{document.querySelectorAll(".nav-item").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-pane").forEach(e=>e.classList.remove("active")),e.classList.add("active");let t=e.dataset.target;document.getElementById(t).classList.add("active"),"content-io"===t?(H={offset:0,loading:!1,hasMore:!0,term:document.getElementById("ioSearch").value.trim()},document.getElementById("ioTableBody").innerHTML="",x()):"content-log"===t&&("internal"===document.getElementById("logSourceSelect").value&&(w={offset:0,loading:!1,hasMore:!0,term:""},document.getElementById("logViewer").innerHTML=""),V())}});const N=async()=>{try{L=await S();let e=await $(`ls ${r}/*.conf 2>/dev/null`);if(p=e?e.split("\n").map(e=>e.split("/").pop().replace(".conf","")).filter(e=>e&&"injector"!==e&&"monitor_ignore"!==e):[],y.clear(),p.length>0){let e=await $(`grep -c "REDIRECT" ${r}/*.conf 2>/dev/null`),t=await $(`grep -c "HIDE" ${r}/*.conf 2>/dev/null`);p.forEach(n=>{let o=RegExp(`${n}\\.conf:(\\d+)`),a=e.match(o),l=t.match(RegExp(`${n}\\.conf:(\\d+)`));y.set(n,{r:a?parseInt(a[1]):0,h:l?parseInt(l[1]):0})})}let t=await $(`cat ${i} 2>/dev/null`);E.clear(),t&&t.split("\n").forEach(e=>{let t=e.trim().split(/\s+/);if(t.length>=2&&!e.trim().startsWith("#")){let e=t.slice(2).join(" ")||"";E.set(t[0],{env:t[1],param:e})}});let n=await l("user")||[],o=await l("system")||[],a=[...new Set([...n,...o])],s=await function(e){try{return"string"!=typeof e&&(e=JSON.stringify(e)),JSON.parse(ksu.getPackagesInfo(e))}catch(e){return[]}}(a);g.clear(),Array.isArray(s)&&s.forEach(e=>{if(e&&e.packageName){let t=E.get(e.packageName);g.set(e.packageName,{...e,boundEnv:t?.env,boundParam:t?.param})}}),D(),O()}catch(e){console.error("Load data error",e),a("数据加载异常: "+e.message)}},D=()=>{try{let e=document.getElementById("appList"),t=document.getElementById("appSearch").value.toLowerCase(),n=[];g.forEach(e=>{if("filterUser"===M&&e.isSystem||"filterSystem"===M&&!e.isSystem||"filterBound"===M&&!e.boundEnv)return;let o=e.appLabel||e.packageName;(!t||o.toLowerCase().includes(t)||e.packageName.toLowerCase().includes(t))&&n.push(e)}),n.sort((e,t)=>!!t.boundEnv-!!e.boundEnv||(e.appLabel||"").localeCompare(t.appLabel||"")),e.innerHTML=n.length?n.map(e=>{let t=L.has(e.packageName)?'<span class="badge badge-success">MOUNTED</span>':"",n="badge-primary",o="",a=e.boundEnv,l=e.boundParam||"";l.includes("MONITOR")?n="badge-warning":l.includes("PASSTHROUGH")&&(n="badge-success"),l.includes("MERGE")&&(a+=" (M)",l.includes("MONITOR")||l.includes("PASSTHROUGH")||(o='style="background:#6f42c1"'));let s=e.boundEnv?`<span class="badge ${n} badge-pill" ${o}>${a}</span>`:"";return`
            <div class="list-item" data-pkg="${e.packageName}" onclick="openAppConfig('${e.packageName}')">
                <div class="app-main">
                    <div class="app-icon-wrapper">${B.ANDROID}</div>
                    <div class="app-content">
                        <div class="app-header"><span class="app-name">${e.appLabel}</span>${t}</div>
                        <small class="text-muted font-monospace text-truncate d-block">${e.packageName}</small>
                    </div>
                </div>
                <div class="app-end">${s}</div>
            </div>`}).join(""):'<div class="empty-state">无匹配应用</div>'}catch(e){console.error("Render app list error",e)}},O=()=>{try{let e=document.getElementById("envList");if(0===p.length){e.innerHTML='<div class="empty-state full-col">暂无环境</div>';return}e.className=`grid-list scroll-y ${"list"===h?"list-mode":""}`,e.innerHTML=p.map(e=>{let t=y.get(e)||{r:0,h:0};return"list"===h?`
                <div class="env-item" onclick="openEnvEditor('${e}')">
                    <div class="env-info"><div class="env-icon">${B.ENV}</div><div class="env-name">${e}</div></div>
                    <div class="env-stats"><span class="badge badge-outline">R: ${t.r}</span><span class="badge badge-outline">H: ${t.h}</span></div>
                </div>`:`<div class="env-item" onclick="openEnvEditor('${e}')"><div class="env-icon">${B.ENV}</div><div class="env-name">${e}</div></div>`}).join("")}catch(e){console.error("Render env list error",e)}};window.openAppConfig=e=>{f=e;let t=g.get(e);if(!t)return;document.getElementById("bindAppName").textContent=t.appLabel,document.getElementById("bindAppPkg").textContent=e,document.getElementById("bindAppIcon").innerHTML=B.ANDROID;let n=document.getElementById("bindEnvSelect");n.innerHTML='<option value="">未绑定 (清除)</option>'+p.map(e=>`<option value="${e}">${e}</option>`).join(""),n.value=t.boundEnv||"";let o=t.boundParam||"",a=document.getElementById("checkMerge");a.checked=o.includes("MERGE"),o.includes("MONITOR")?document.getElementById("modeMonitor").checked=!0:o.includes("PASSTHROUGH")?document.getElementById("modePassthrough").checked=!0:document.getElementById("modeDefault").checked=!0;let l=()=>{let e=document.getElementById("modePassthrough").checked;a.disabled=e,e&&(a.checked=!1)};l(),document.querySelectorAll('input[name="bindMode"]').forEach(e=>e.onchange=l),openModal("appConfigModal")},document.getElementById("btnSaveBinding").onclick=async()=>{try{let e=document.getElementById("bindEnvSelect").value,n=document.querySelector('input[name="bindMode"]:checked')?.value||"",o=document.getElementById("checkMerge").checked,l=[];n&&l.push(n),o&&"PASSTHROUGH"!==n&&l.push("MERGE");let s=l.join(" ");e?E.set(f,{env:e,param:s}):E.delete(f);let r="# Generated by WebUI\n";E.forEach((e,t)=>{r+=`${t} ${e.env} ${e.param}
`}),await t(`echo '${r}' > ${i}`),a("绑定已更新"),closeModal("appConfigModal"),N()}catch(e){a("保存失败: "+e.message)}},window.openModal=e=>{let t=document.getElementById(e);t&&(t.classList.remove("hiding"),t.classList.add("show"))},window.closeModal=e=>{let t=document.getElementById(e);t&&t.classList.contains("show")&&(t.classList.add("hiding"),setTimeout(()=>{t.classList.remove("show"),t.classList.remove("hiding")},250),document.getElementById("suggestionBox").style.display="none")};const F=e=>e?e.startsWith(m)?e.substring(m.length)||"/":e.startsWith(u)?e.substring(u.length)||"/":e:"",q=(e,t)=>e?(e=e.trim(),t)?e.startsWith("/")?e:(u+"/"+e).replace(/\/+/g,"/"):e.startsWith("/")?e:(m+"/"+e).replace(/\/+/g,"/"):"";document.getElementById("btnToggleStatus").onclick=async()=>{try{let e=document.getElementById("btnToggleStatus");"running"===e.getAttribute("data-status")?b?(await $(`kill -15 ${b}`),a("发送停止信号...")):a("服务未运行"):(await $("sh /data/adb/modules/Namespace-Proxy/service.sh"),a("启动服务..."),setTimeout(N,1e3)),setTimeout(A,500),setTimeout(A,1500)}catch(e){a("操作失败: "+e.message)}},window.openEnvEditor=async e=>{v=e,document.getElementById("editorEnvName").textContent=e;let t=await $(`cat ${r}/${e}.conf 2>/dev/null`);document.getElementById("envRuleContent").value=t,P(t),document.getElementById("editorAlert").classList.remove("collapsed"),document.querySelector("#envEditorModal .modal-content").classList.remove("dark-theme");let n=document.querySelector('input[name="editorMode"][value="visual"]');n&&(n.checked=!0,n.dispatchEvent(new Event("change"))),openModal("envEditorModal")};const P=e=>{let t=document.getElementById("ruleBuilderContainer");t.innerHTML="",e&&e.split("\n").forEach(e=>{let t=e.trim().split(/\s+/);"REDIRECT"===t[0]&&t.length>=3?j("REDIRECT",F(t[1]),F(t.slice(2).join(" "))):"HIDE"===t[0]&&t.length>=2&&j("HIDE",F(t[1]),"")}),0===t.children.length&&j("REDIRECT","","")},j=(e,t,n)=>{let o=document.createElement("div");o.className="rule-row",o.innerHTML=`<select class="form-select rule-type"><option value="REDIRECT">\u{91CD}\u{5B9A}\u{5411}</option><option value="HIDE">\u{9690}\u{85CF}</option></select><div class="rule-inputs"><input type="text" class="form-control rule-target" placeholder="\u{539F}\u{59CB}\u{8DEF}\u{5F84}" value="${t}"><input type="text" class="form-control rule-source ${"HIDE"===e?"hidden":""}" placeholder="\u{91CD}\u{5B9A}\u{5411}\u{81F3}" value="${n}"></div><button class="btn btn-icon-sm btn-del">${B.DELETE}</button>`;let a=o.querySelector(".rule-type");a.value=e,a.onchange=e=>o.querySelector(".rule-source").classList.toggle("hidden","HIDE"===e.target.value),o.querySelector(".btn-del").onclick=()=>o.remove(),_(o.querySelector(".rule-target")),_(o.querySelector(".rule-source")),document.getElementById("ruleBuilderContainer").appendChild(o)},Z=e=>{let t=document.getElementById("suggestionBox");if("none"===t.style.display||!e)return;let n=e.getBoundingClientRect(),o=.5*window.innerHeight;t.style.width=n.width+"px",t.style.left=n.left+"px",n.bottom>o?(t.style.top="auto",t.style.bottom=window.innerHeight-n.top+"px",t.style.maxHeight=n.top-10+"px",t.style.borderRadius="8px 8px 0 0",t.style.borderBottom="none",t.style.borderTop="1px solid var(--border)"):(t.style.top=n.bottom+"px",t.style.bottom="auto",t.style.maxHeight=window.innerHeight-n.bottom-10+"px",t.style.borderRadius="0 0 8px 8px",t.style.borderTop="none",t.style.borderBottom="1px solid var(--border)")},_=e=>{let n=document.getElementById("suggestionBox"),o=k(async o=>{let a=m,l="",s="/",r=o?o.replace(/^\/+/,""):"";if(r)if(r.endsWith("/"))a=m+"/"+r,s="/"+r;else{let e=r.lastIndexOf("/");if(-1===e)l=r;else{let t=r.substring(0,e+1);a=m+"/"+t,l=r.substring(e+1),s="/"+t}}else a=m+"/";a=a.replace(/\/+/g,"/");try{let o=await t(`ls -F -1 "${a}" 2>/dev/null | head -n 30`);if(!o||!o.stdout){n.style.display="none";return}let r=o.stdout.split("\n").filter(e=>e.startsWith(l)).map(e=>{let t=e.endsWith("/");return{text:s+e+"",icon:t?B.FOLDER:B.FILE}});if(0===r.length){n.style.display="none";return}n.innerHTML=r.map(e=>`<div class="suggestion-item" onmousedown="event.preventDefault()" onclick="window.applySuggestion('${e.text}')"><div class="s-icon">${e.icon}</div><div class="s-text">${e.text}</div></div>`).join(""),n.style.display="block",Z(e);let i=document.getElementById("suggestionBox"),c=()=>{"none"!==i.style.display&&window._currentInput===e&&(Z(e),requestAnimationFrame(c))};requestAnimationFrame(c)}catch(e){n.style.display="none"}},150);e.addEventListener("input",e=>o(e.target.value)),e.addEventListener("focus",()=>{window._currentInput=e,e.value&&e.dispatchEvent(new Event("input"))})};window.applySuggestion=e=>{window._currentInput&&(window._currentInput.value=e,window._currentInput.dispatchEvent(new Event("input")))};const U=(e,t,n,o,a,l,s,r,i)=>{let c=document.getElementById(a),d=document.getElementById(n),u=document.getElementById(o),m=document.getElementById(l)||document.querySelector(`#${t} .fab-container`),g=document.querySelector(`#${t} .modal-content`);e?(g.classList.remove("dark-theme"),u.classList.remove("active"),setTimeout(()=>{u.classList.add("hidden"),d.classList.remove("hidden"),c.classList.remove("collapsed"),m.classList.remove("hidden"),r(document.getElementById(s).value),requestAnimationFrame(()=>{d.classList.add("active")})},250)):(g.classList.add("dark-theme"),d.classList.remove("active"),c.classList.add("collapsed"),m.classList.add("hidden"),setTimeout(()=>{d.classList.add("hidden"),u.classList.remove("hidden"),document.getElementById(s).value=i(),requestAnimationFrame(()=>{u.classList.add("active")})},250))};document.querySelectorAll('input[name="editorMode"]').forEach(e=>{e.onchange=e=>U("visual"===e.target.value,"envEditorModal","editorVisual","editorRaw","editorAlert",null,"envRuleContent",P,W)});const G=async()=>{let e=await $(`cat ${c} 2>/dev/null`);document.getElementById("monitorIgnoreContent").value=e,parseIgnoreToVisual(e),document.getElementById("alertIgnore").classList.remove("collapsed"),document.querySelector("#monitorIgnoreModal .modal-content").classList.remove("dark-theme");let t=document.querySelector('input[name="ignoreMode"][value="visual"]');t&&(t.checked=!0,t.dispatchEvent(new Event("change"))),openModal("monitorIgnoreModal")};document.querySelectorAll('input[name="ignoreMode"]').forEach(e=>{e.onchange=e=>U("visual"===e.target.value,"monitorIgnoreModal","ignoreVisual","ignoreRaw","alertIgnore","fabIgnore","monitorIgnoreContent",parseIgnoreToVisual,generateIgnoreFromVisual)});const W=()=>{let e="";return document.querySelectorAll("#ruleBuilderContainer .rule-row").forEach(t=>{let n=t.querySelector(".rule-type").value,o=t.querySelector(".rule-target").value.trim(),a=t.querySelector(".rule-source").value.trim();o&&("REDIRECT"===n&&a?e+=`REDIRECT ${q(o,!0)} ${q(a,!1)}
`:"HIDE"===n&&(e+=`HIDE ${q(o,!0)}
`))}),e};document.getElementById("btnCreateEnv").onclick=async()=>{try{let e=document.getElementById("newEnvName").value.trim();if(!e)return a("名称不能为空");await t(`touch ${r}/${e}.conf`),closeModal("newEnvModal"),N()}catch(e){a("创建失败: "+e.message)}},document.getElementById("btnDeleteEnv").onclick=async()=>{try{if(!confirm(`\u{786E}\u{5B9A}\u{5220}\u{9664}\u{73AF}\u{5883} ${v} \u{5417}?`))return;await $(`rm ${r}/${v}.conf`);let e="# Generated by WebUI\n";E.forEach((t,n)=>{t.env!==v&&(e+=`${n} ${t.env} ${t.param}
`)}),await t(`echo '${e}' > ${i}`),closeModal("envEditorModal"),N()}catch(e){a("删除失败: "+e.message)}},document.getElementById("btnSaveEnv").onclick=async()=>{try{let e=document.querySelector('input[name="editorMode"][value="visual"]').checked?W():document.getElementById("envRuleContent").value;await t(`echo '${e}' > ${r}/${v}.conf`),a("规则已保存"),closeModal("envEditorModal"),N()}catch(e){a("保存失败: "+e.message)}},document.getElementById("btnAddRuleRow").onclick=()=>j("REDIRECT","","");